{
  "hash": "bab6e96246fecb615800d3b2016ffc96",
  "result": {
    "markdown": "---\ntitle: \"Visualization of Spatial Data\"\n---\n\n\n## Outline\n\n- Quick recap of `plot()`\n- Pretty (and useful) maps with `{ggplot2}`\n- Visualizing point density\n- Visualize individual animal movement\n\n## `plot` sf objects\n\nPreviously we used `plot()` to view our `sf` objects - this is a nice quick way\nto visualize our data for verification or glance at the different variables.\n\nFirst, read in the caribou data:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(sf)\nlibrary(dplyr)\n\ncaribou <- read_sf(\"clean_data/caribou.gpkg\")\n\nplot(caribou)\n```\n\n::: {.cell-output-display}\n![](04-spatial-data-viz_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\nYou can see that by default, this plots all of the attributes (up to 9). But we \ncan plot just the points by extracting just the geometry with `st_geometry()`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nst_geometry(caribou) |> \n  plot()\n```\n\n::: {.cell-output-display}\n![](04-spatial-data-viz_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\nOr, plot just one or a few variables of interest:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncaribou |> \n  select(herd, animal.sex) |> # select just the herd and sex columns\n  plot(key.pos = 1) # put the legend at the bottom\n```\n\n::: {.cell-output-display}\n![](04-spatial-data-viz_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\nWe can also add a base map for context. Let's use the `bcmaps` package to get a \nbase map. `{bcmaps}` has a large collection of useful maps of B.C.:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(bcmaps)\n\navailable_layers()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 37 × 6\n   layer_name                title         record resource using_shortcuts local\n * <chr>                     <chr>         <chr>  <chr>    <lgl>           <lgl>\n 1 airzones                  British Colu… e8eee… c495d08… TRUE            FALSE\n 2 bc_bound                  BC Boundary   b9bd9… f591698… FALSE           FALSE\n 3 bc_bound_hres             High Resolut… 30aeb… 3d72cf3… FALSE           FALSE\n 4 bc_cities                 BC Major Cit… b678c… 443dd85… TRUE            FALSE\n 5 bc_neighbours             Boundary of … b9bd9… f591698… FALSE           FALSE\n 6 bec                       British Colu… f358a… 3ec24cb… TRUE            FALSE\n 7 cded_raster               Get Canadian… <NA>   <NA>     FALSE           FALSE\n 8 cded_stars                Get Canadian… <NA>   <NA>     FALSE           FALSE\n 9 census_dissemination_area Current Cens… a091f… a7fa66d… TRUE            FALSE\n10 census_division           Current Cens… ef179… 36b530c… TRUE            FALSE\n# ℹ 27 more rows\n\n------------------------\nAll layers are downloaded from the internet and cached\non your hard drive at /Users/andy/Library/Caches/org.R-project.R/R/bcmaps.\n```\n:::\n:::\n\n\nLet's get the B.C. Natural resource boundaries:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnr <- nr_districts()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nnr_districts was updated on 2023-11-03\n```\n:::\n\n```{.r .cell-code}\nst_geometry(nr) |> \n  plot()\n\ncaribou |> \n  st_transform(st_crs(nr)) |> # transform so in the same crs as nr\n  select(herd) |> # select just the herd column (called herd)\n  plot(add = TRUE)\n```\n\n::: {.cell-output-display}\n![](04-spatial-data-viz_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nBut we can quickly get past the point where basic plotting lets us do what we \nwant to do...\n\n## ggplot2\n\n[ggplot2](https://ggplot2.tidyverse.org) is a plotting package built on the theory of the \"Grammar of Graphics\", where a plot is built up in layers:\n\n1. We start with the data, then \n2. add the graphical marks (points, lines, bars, etc. called \"geom\"s) we want to use\nto represent the data, and \n3. specify \"aesthetics\" for how to map variables in our data to\nvisual representations on the plot.\n\nLet's start with a simple histogram of fixes over time:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\n\nggplot(data = caribou) + # start with data\n  geom_histogram( # specify the geom\n    aes( # specify aesthetics - how to map variables to visual representations\n      x = date_time\n    ), \n    position = \"dodge\" # make the bars side by side instead of stacked\n  )\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n:::\n\n::: {.cell-output-display}\n![](04-spatial-data-viz_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nWe can add a \"fill\" aesthetic to differentiate herds, i.e., group the bars by\nherd, and use a different fill colour for each herd:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncaribou <- transform_bc_albers(caribou)\n\nggplot(data = caribou) + # start with data\n  geom_histogram( # specify the geom\n    aes( # specify aesthetics - how to map variables to visual representations\n      x = date_time,\n      fill = herd\n    ), \n    position = \"dodge\" # make the bars side by side instead of stacked\n  )\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n:::\n\n::: {.cell-output-display}\n![](04-spatial-data-viz_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\nWe can use the same pattern to make a map:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = caribou) +\n  geom_sf() # x and y are inferred from the geometry column\n```\n\n::: {.cell-output-display}\n![](04-spatial-data-viz_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = caribou) +\n  geom_sf(\n    aes(colour = herd, shape = animal.sex)\n  )\n```\n\n::: {.cell-output-display}\n![](04-spatial-data-viz_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\nWe have a lot of overlapping points, so the actual density of fixes is \nobscured. We can address this in several ways:\n\n### Transparency\n\nWe can see the density of points better by making them partially transparent. \nWe do this by setting the `alpha` parameter to a value between 0 and 1 \n(0 is fully transparent, 1 is fully opaque).\n\nNote that we are setting `alpha` to a constant value *outside* the `aes()` call, \nso the setting applies equally to all points (it is not mapped to a variable).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = caribou) +\n  geom_sf(\n    aes(colour = herd), \n    alpha = 0.1\n  ) + \n  scale_colour_viridis_d() + \n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](04-spatial-data-viz_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\nWe can subset our plot into \"small multiples\", or \"facets\" - making a small\nplot for each level of a variable in our data. For example, let's look at the \ndistribution of points in each month, still colouring the points by herd:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = caribou) +\n  geom_sf(\n    aes(colour = herd), \n    alpha = 0.1\n  ) + \n  scale_colour_viridis_d() + \n  facet_wrap(vars(month)) +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](04-spatial-data-viz_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n#### Your turn\n\nRead in the scott data (`clean_data/scott_herd_subset.gpkg`), \nand plot the fixes, coloured by reproductive condition, and faceted by season \nand year. Hint: see `?facet_grid`.\n\nFor bonus points, remove the lat/long labels using the `theme()` function.\n\n::: {.callout-tip collapse=\"true\"}\n## solution\n\n\n::: {.cell}\n\n```{.r .cell-code}\nscott <- read_sf(\"clean_data/scott_herd_subset.gpkg\")\n\nggplot(scott) +\n  geom_sf(aes(colour = animal.reproductive.condition), alpha = 0.3) + \n  facet_grid(season ~ year) + \n  theme(axis.text = element_blank())\n```\n\n::: {.cell-output-display}\n![](04-spatial-data-viz_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\nto get the seasons in a sensible order, set them to a factor and define the order\nof the levels:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(scott) +\n  geom_sf(aes(colour = animal.reproductive.condition), alpha = 0.3) + \n  facet_grid(\n    factor(season, levels = c(\"winter\", \"spring\", \"summer\", \"fall\")) ~ year\n  ) + \n  theme(axis.text = element_blank())\n```\n\n::: {.cell-output-display}\n![](04-spatial-data-viz_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n:::\n\n### Binning\n\nAnother way to look at the density of points is binning - sort of like a spatial \nhistogram, but instead of using bar height to represent relative numbers, use \ncolour. We can use `geom_hex()` to divide our space up into a hexagonal grid\nand colour the hexagons based on the number of points in each:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Start by extracting the X and Y coordinates as columns in our data set:\ncaribou <- cbind(st_coordinates(caribou), caribou)\n\nhead(caribou)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSimple feature collection with 6 features and 17 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: 1149513 ymin: 1207479 xmax: 1159827 ymax: 1214219\nProjected CRS: NAD83 / BC Albers\n        X       Y location.long location.lat  herd tag.local.identifier\n1 1149513 1214219     -123.6036     55.90000 Scott               car170\n2 1149921 1211265     -123.5987     55.87343 Scott               car170\n3 1150438 1211425     -123.5903     55.87470 Scott               car170\n4 1156753 1207479     -123.4915     55.83741 Scott               car170\n5 1157677 1212132     -123.4740     55.87877 Scott               car170\n6 1159827 1209456     -123.4412     55.85412 Scott               car170\n  animal.id animal.sex animal.reproductive.condition tag.manufacturer.name\n1 SC_car170          f                  with calf: N                   ATS\n2 SC_car170          f                  with calf: N                   ATS\n3 SC_car170          f                  with calf: N                   ATS\n4 SC_car170          f                  with calf: N                   ATS\n5 SC_car170          f                  with calf: N                   ATS\n6 SC_car170          f                  with calf: N                   ATS\n    tag.model           date_time year month day hour minute\n1 GPS Iridium 2013-09-23 03:01:00 2013     9  23   10      1\n2 GPS Iridium 2013-10-09 03:01:00 2013    10   9   10      1\n3 GPS Iridium 2013-10-30 03:01:00 2013    10  30   10      1\n4 GPS Iridium 2014-08-11 03:01:00 2014     8  11   10      1\n5 GPS Iridium 2013-11-09 18:01:00 2013    11  10    2      1\n6 GPS Iridium 2014-08-07 03:01:00 2014     8   7   10      1\n                     geom\n1 POINT (1149513 1214219)\n2 POINT (1149921 1211265)\n3 POINT (1150438 1211425)\n4 POINT (1156753 1207479)\n5 POINT (1157677 1212132)\n6 POINT (1159827 1209456)\n```\n:::\n\n```{.r .cell-code}\nggplot(data = caribou) +\n  geom_hex(aes(x = X, y = Y)) + \n  scale_fill_viridis_c() + \n  coord_sf() +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](04-spatial-data-viz_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\nWe can still use faceting to split out the two herds:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = caribou) +\n  geom_hex(aes(x = X, y = Y)) + \n  scale_fill_viridis_c() + \n  coord_sf() +\n  facet_wrap(vars(herd)) +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](04-spatial-data-viz_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\nIf we want to add multiple layers to our map, we simply add multiple geoms, and\nadd the name of the layer to the `data` argument in each:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = nr) + \n  geom_hex(aes(x = X, y = Y), data = caribou) + \n  scale_fill_viridis_c() + \n  facet_wrap(vars(herd)) +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](04-spatial-data-viz_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\nWe can zoom in by specifying the plot limits in `coord_sf()`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = nr) + \n  geom_hex(aes(x = X, y = Y), data = caribou) + \n  scale_fill_viridis_c() + \n  coord_sf(\n    xlim = range(caribou$X) + c(-20000, 20000), # Add 20 km to all sides\n    ylim = range(caribou$Y) + c(-20000, 20000)\n  ) +\n  facet_wrap(vars(herd)) +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](04-spatial-data-viz_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\n## Probability density\n\nWe can also visualize a smooth probability density of fixes, using the \n`{ggdensity}` package:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggdensity)\n\nggplot(data = caribou) +\n  geom_hdr(aes(x = X, y = Y, fill = herd)) + \n  coord_sf() + \n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](04-spatial-data-viz_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\nThe regions have probabilities mapped to the `alpha` aesthetic by default - the `probs` legend shows the alhpa levels.\n\nNow let's do a bit of work to make the plot look more finished:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmonth_labels <- setNames(month.name, 1:12)\n\nggplot(data = caribou) +\n  geom_hdr(aes(x = X, y = Y, fill = herd)) + \n  scale_fill_viridis_d(option = \"turbo\") + \n  scale_alpha_discrete(guide = \"none\") +\n  coord_sf() + \n  facet_wrap(\n    vars(month),\n    labeller = as_labeller(month_labels)\n    ) +\n  theme_bw() + \n  labs(\n    title = \"Probability density of caribou locations, by month\", \n    x = element_blank(), \n    y = element_blank(), \n    fill = \"Herd\"\n  )\n```\n\n::: {.cell-output-display}\n![](04-spatial-data-viz_files/figure-html/unnamed-chunk-19-1.png){width=960}\n:::\n:::\n\n\n## Add a base map, north arrow, & scale\n\nWe can use functions from the `{ggspatial}` package to add some nice \ntouches to our map to make it pretty.\n\nWe can also customize the labels, legend, and theme elements\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# install.packages(c(\"ggspatial\", \"prettymapr\"))\nlibrary(ggspatial)\n\nggplot(caribou) +\n  # add background map\n  annotation_map_tile(zoom = 9) + \n  # add points\n  geom_sf(aes(colour = herd), alpha = 0.1) + \n  # set colour palette and increase legend alpha so you can see it\n  scale_colour_viridis_d(\n    option = \"turbo\", \n    guide = guide_legend(override.aes = list(alpha = 0.5))) + \n  # Add a North arrow and scale bar\n  annotation_north_arrow(style = north_arrow_nautical()) + \n  annotation_scale(location = \"tr\") + \n    coord_sf() + \n  # Facet by month, custom label the facets\n  facet_wrap(\n    vars(month),\n    labeller = as_labeller(month_labels)\n    ) +\n  # Add a title, remove X and Y labels\n  labs(\n    title = \"Probability density of caribou locations, by month\", \n    x = element_blank(), \n    y = element_blank(), \n    colour = \"Herd\"\n  ) + \n  # Set background of facet labels and legend to white, \n  # put legend on the bottom\n  theme(\n    strip.background = element_rect(fill = \"white\"),\n    legend.key = element_rect(fill = \"white\"),\n    legend.position = \"bottom\"\n  )\n```\n\n::: {.cell-output-display}\n![](04-spatial-data-viz_files/figure-html/unnamed-chunk-20-1.png){width=960}\n:::\n:::\n\n\nWe can also look at the movement of just one or two animals:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nscott <- read_sf(\"clean_data/scott_herd_subset.gpkg\")\n\nscott <- cbind(st_coordinates(scott), scott)\n\nmvmt <- scott |> \n  filter(animal.id == \"SC_car171\")\n\nggplot(mvmt) + \n  geom_path(aes(x = X, y = Y, colour = date2)) +\n  scale_color_viridis_c(n.breaks = 6, trans = \"date\") + \n  coord_sf() + \n  labs(colour = \"Date\") + \n  theme_bw() + \n  theme(\n    axis.title = element_blank(),\n    legend.position = \"bottom\",\n    legend.key.width = unit(4, \"lines\")\n  )\n```\n\n::: {.cell-output-display}\n![](04-spatial-data-viz_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\n## Your turn:\n\nModify the previous map to make a faceted (small-multiples) map for two \nor more animals, and add a background map.\n\n::: {.callout-tip collapse=\"true\"}\n## Solution\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntop_animals <- c(\"SC_car171\", \"SC_car168\")\n\nmvmt <- scott |> filter(animal.id %in% top_animals)\n\nggplot(mvmt) + \n  annotation_map_tile(zoom = 10) +\n  geom_path(aes(x = X, y = Y, colour = date2)) + \n  facet_wrap(vars(animal.id)) +\n  scale_color_viridis_c(n.breaks = 6, trans = \"date\") + \n  coord_sf() + \n  labs(colour = \"Date\") + \n  theme(\n    axis.title = element_blank(),\n    axis.text = element_blank(),\n    axis.ticks = element_blank(),\n    legend.position = \"bottom\",\n    legend.key.width = unit(4, \"lines\")\n  )\n```\n\n::: {.cell-output-display}\n![](04-spatial-data-viz_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n\n:::\n\n",
    "supporting": [
      "04-spatial-data-viz_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}