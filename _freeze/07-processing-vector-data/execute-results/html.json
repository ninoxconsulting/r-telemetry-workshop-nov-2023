{
  "hash": "4008b9ff8a54c703150ac69b1f589b64",
  "result": {
    "markdown": "---\ntitle: \"Processing Base Vector Data\"\nparams:\n  write: true\n---\n\n\n## Overview:\n\nIn this module we will post-process vector data we prepared [earlier](05-vector-bcdata.qmd) using the **terra** package. This includes;\n\n-   generate a road impact raster\n\n-   calculate a distance to water raster\n\n-   converte vectors to rasters\n\n-   combine all rasters into a raster stack and export\n\n## 1. Road influence\n\nTo assemble meaningful information for modelling, we often need to post-process vector data. This could include manipulating the data into categories (i.e. high, medium, low) or exploring spatial patterns in more detail (i.e. distance from a road)\n\nIn this example we will generate a raster to quantifying the impact of road type and spatial orientation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load in the libraries needed\n\nlibrary(bcdata)\nlibrary(sf)\nlibrary(dplyr)\nlibrary(terra)\n\n# read in raster template\ntemplate <- rast(\"clean_data/template.tif\")\n\n# read in roads\nroads <- read_sf(\"clean_data/roads.gpkg\")\n```\n:::\n\n\nWe can assume the impact of road type (ROAD_SURFACE) might have a different impact on Caribou avoidance or predator use.\n\nWe can use this column to assign values to reflect this. In this example we assign a higher value to roads that are likely to be traveled at a higher speed and would have more frequent use.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# assign a value to the roads based on estimated speed of travel or use\n\nroads <- roads |>\n  mutate(rd_value = case_when(\n            ROAD_SURFACE == \"loose\" ~ 25,\n            ROAD_SURFACE == \"overgrown\" ~ 5,\n            ROAD_SURFACE == \"rough\" ~ 10,\n            ROAD_SURFACE == \"unknown\" ~ 7.5)) \n```\n:::\n\n\nNow we can convert the vector to a raster using the template\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# convert roads to a raster \nrroads <- rasterize(roads, template, field = \"rd_value\" )\n\nplot(rroads)\n```\n\n::: {.cell-output-display}\n![](07-processing-vector-data_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\nSecondly, we can assume the impact of the road will have a wider influence than a single pixel. To capture this influence we use a moving window analysis.\n\nMoving windows or focal calculations estimate a new value for each pixel based on the values of the surrounding pixels (neighbours) and the function we supply. In this example we will use a window of 9, and a calculation based on the sum of these 9 pixels.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# create a moving window \n\nrrdens <- focal(rroads, w=9, fun=\"sum\", na.rm=TRUE)\n\nplot(rrdens)\n```\n\n::: {.cell-output-display}\n![](07-processing-vector-data_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nwriteRaster(rrdens, \"clean_data/road_density.tif\", overwrite = TRUE) \n```\n:::\n\n\n## 2. Calculate distance from water\n\nWe might also be interested in understanding the relationship between Caribou locations and distance to a particular feature or habitat type.\n\nIn this case we will explore the distance to water bodies within the study areas.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# read in water \nwater <- read_sf(\"clean_data/water.gpkg\")\n\n# calculate the distance to water for each pixel in the raster\n# be patient - this might take some time. \nwater_dis <- distance(template, water, unit = \"km\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n|---------|---------|---------|---------|\n=========================================\n                                          \n```\n:::\n\n```{.r .cell-code}\nplot(water_dis)\nplot(water$geom, add = T)\n```\n\n::: {.cell-output-display}\n![](07-processing-vector-data_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# what sort of values are we seeing?\nrange(water_dis)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nclass       : SpatRaster \ndimensions  : 1484, 1536, 2  (nrow, ncol, nlyr)\nresolution  : 25, 25  (x, y)\nextent      : 1145900, 1184300, 1190400, 1227500  (xmin, xmax, ymin, ymax)\ncoord. ref. : NAD83 / BC Albers (EPSG:3005) \nsource(s)   : memory\nnames       : range_min, range_max \nmin values  :  0.000000,  0.000000 \nmax values  :  5.923032,  5.923032 \n```\n:::\n:::\n\n\n## 3. Convert base vector data to rasters\n\nTo prepare rasters for modelling and further analysis, we can convert all our vector data into one standard raster stack.\n\nNote: it is not always required to convert to a raster stack, but this is helpful for any future predictions.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# read in our prepared vector data sets\nbec <- read_sf(\"clean_data/bec.gpkg\")\nvri_conif <- read_sf(\"clean_data/vri_conif.gpkg\")\nvri_ageclass <- read_sf(\"clean_data/vri_ageclass.gpkg\")\nvri_cc <- read_sf(\"clean_data/vri_cc.gpkg\")\ncutblocks <- read_sf(\"clean_data/cutblocks.gpkg\")\nwater <- read_sf(\"clean_data/water.gpkg\")\nstreams <- read_sf(\"clean_data/streams.gpkg\")\nroads <- read_sf(\"clean_data/roads.gpkg\")\n\n\n# convert to rasters\nrbec <- rasterize(bec, template, field = \"MAP_LABEL\")\nrvri_conif <- rasterize(vri_conif, template, field = \"conif\")\nrvri_ageclass <- rasterize(vri_ageclass, template, field = \"age_class\")\nrvri_cc <- rasterize(vri_cc, template, field = \"cc_class\" )\nrcutblocks <- rasterize(cutblocks, template, field = \"HARVEST_YEAR\")\nrwater <- rasterize(water, template, field = \"WATERBODY_TYPE\" )\nrstreams <- rasterize(streams, template, field = \"STREAM_ORDER\" )\nrroads <- rasterize(roads, template, field = \"ROAD_SURFACE\" )\n\n\n# stack into a set of rasters\n\nvect_stack <- c(rbec, rvri_conif, rvri_ageclass, rvri_cc,\n                rcutblocks, rwater, rstreams, rroads, \n                water_dis, rrdens)\n\nplot(vect_stack)\n```\n\n::: {.cell-output-display}\n![](07-processing-vector-data_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\nLets combine these with the terrain rasters we created [earlier](06-raster-data.qmd).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrslope <- rast(\"clean_data/slope.tif\")\nraspect <- rast(\"clean_data/aspect.tif\")\nrtri  <- rast(\"clean_data/tri.tif\")\nrtrim_3005 <- rast(\"clean_data/dem.tif\")\n\n\n# create a raster stack\nrast_stack <- c(rtrim_3005, rslope, raspect, rtri)\n```\n:::\n\n\n## 4. Combine raster layers into a stack\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# lets combine both the raster stack and the vector stack \n\nall_stack <- c(vect_stack, rast_stack)\n\nplot(all_stack)\n```\n\n::: {.cell-output-display}\n![](07-processing-vector-data_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# we can write this out as a tif (raster object) \n#writeRaster(all_stack, \"clean_data/rstack.tif\", overwrite = T)\n```\n:::\n\n\nOr we can write this out to a very small R object\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsaveRDS(all_stack, \"clean_data/covars.RDS\") # much faster\n```\n:::\n\n\n## Your turn\n\n1.  Generate a road density later using a different function (i.e. not sum), and or different scale of window (w). Hint: use the ?focal to see other options available.\n\n::: {.callout-tip collapse=\"true\"}\n## Solution:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# One example would be to generate the \"max\" value of the moving window. Note the w parameter is also reduced in the example. \n\nrrdensmax <- focal(rroads, w=3, fun=\"max\", na.rm=TRUE)\n```\n:::\n\n:::\n\n::: {.callout-tip collapse=\"true\"}\n2.  Select another linear feature (roads, steams) and generate a raster to capture the distance to that feature for the study area.\n\nSolution:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#This solution generates a distance from roads covariate\n\n# read in roads\nroads <- read_sf(\"clean_data/roads.gpkg\")\n\n# calculate distance - be patient this might take time. \nroad_dis <- distance(template, roads, unit = \"km\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n|---------|---------|---------|---------|\n=========================================\n                                          \n```\n:::\n\n```{.r .cell-code}\nplot(road_dis)\n```\n\n::: {.cell-output-display}\n![](07-processing-vector-data_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n:::\n",
    "supporting": [
      "07-processing-vector-data_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}