{
  "hash": "49c9bfe464331e07a14e78e40a452b12",
  "result": {
    "markdown": "---\ntitle: \"Generating Home Range Estimates\"\neval: false\n---\n\n\n## Overview\n\nIn this module we will create home range estimates using minimum convex polygons and kernel density estimates (kde) exploring a range of methods available.\n\n### 1. Preparation\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(sf)\nlibrary(mapview)\n#library(ggdensity)\nlibrary(adehabitatHR)\nlibrary(sp)\nlibrary(dplyr)\n\n# read in sf object \nbou <- read_sf(\"clean_data/caribou.gpkg\") \n\n# add seasons \nbou <- bou |> \n  mutate(season = case_when(\n            month %in% c(4,5) ~ \"spring\",\n            month %in% c(6,7,8) ~ \"summer\",\n            month %in% c(9,10,11) ~ \"fall\",\n            month %in% c(12,1,2,3) ~ \"winter\")) \n\n# add coordinates\ntdf <- st_coordinates(bou) |> \n    cbind(bou) |>\n    dplyr::select(location.long, location.lat, herd, animal.id, season) %>% \n    st_drop_geometry()\n```\n:::\n\n\nLets begin by checking we have enough points to be confident in our home range estimate. The total number of raw fixes will vary depending between individuals by season and years. In this example we will use a minimum of 50 unique locations as recommended for home range calculations (Seaman 1999, Kernohan 2001).\n\n**Note:** telemetry data is yet to be subset by a specific time interval and currently includes all raw fixes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nid_pts <- tdf |>\n      group_by(animal.id)|>\n      summarise(count = n())\n\nseason_pts <- tdf |>\n      group_by(herd, season)|>\n      summarise(count = n())\n```\n:::\n\n\n### 2. Minimum Convex Polygons\n\nMinimum convex polygons (mcp) can be used to provide a quick estimate of data distribution. This provides a very broad brush approach and does not include density estimates.\n\n2.1 Using the **sf** package.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmcp <- st_convex_hull(st_union(bou))\nplot(mcp)\nplot(bou$geom, col = \"blue\", add = T)\n\n#this is not very representative so what other methods can we use. \n```\n:::\n\n\n2.2 Using the **sp** package.\n\nAlternatively we can use the **adhabitatHR** package, which contains many ecology specific tools and functions. The downside of using this package is the reliance on old spatial package (**sp**) . The **sp** package has largely been superseded by the **sf** package. Unfortunately this is the reality of a coding language which is constantly being updated and improved!\n\nThe **sp** package uses a specific format called SpatialPointsDataFrame. To use these functions we need to convert from sf to sp formats.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#  Create SpatialPointsDataFrame object\n  tdfid <- tdf %>% dplyr::select(location.long, location.lat, animal.id)\n\n  coordinates(tdfid) <- c(\"location.long\", \"location.lat\")\n  proj4string(tdfid) <- CRS( \"+proj=longlat +datum=WGS84 +units=m +no_defs\" )\n  \n  tdfgeo <- spTransform(tdfid, CRS(\"+init=epsg:3005\")) # transform\n   \n  # Calculate MCPs \n  c.mcp <- mcp(tdfgeo, percent = 100)\n  \n  # convert this to a sf object \n  c.mcp_sf <- st_as_sf(c.mcp)\n  \n  # plot with mapview\n  mapview::mapview(c.mcp_sf)\n```\n:::\n\n\nThe advantage of using this package is that it provides many more outputs and enables us to customise the information we want. For example we can extract multiple homeranges based on varying levels of specificity; i.e. percent = 75%.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n  # lets look at 75% inclusion\n  c.mcp.75 <- mcp(tdfgeo , percent = 75)\n\n   # Plot\n  plot(tdfgeo, col = as.factor(tdfgeo$animal.id), pch = 16)\n  plot(c.mcp, col = alpha(1:5, 0.5), add = TRUE)\n  plot(c.mcp.75, col = alpha(1:5, 0.5), add = TRUE)\n  \n  # Calculate the MCP by including 50 to 100 percent of points\n  hrarea <- mcp.area(tdfgeo, percent = seq(50, 100, by = 10))\n```\n:::\n\n\n### 3. Kernel Density Estimates (kde)\n\nKernel Density Estimates (kde) are a popular method to estimate the distribution of data, hence are used to estimate home ranges. Calculations for KDE require consideration of the mathematical method to describe the density function. A detailed description of the parameters can be found [here](http://www.spatialecology.com/gme/kde.htm).\n\nKDEs are very sensitive to input parameters, specifically the bandwidth (h) which determines the [smoothing parameter](https://cran.r-project.org/web/packages/adehabitatHR/vignettes/adehabitatHR.pdf). H parameters can be estimated using three methods:\n\n-   a reference bandwidth (h = σ × n \\^−1/6), however this is generally an overestimate of the range, and is not suitable for multi-modal distributions.\n-   Least Square Cross Validation (LSCV), which minimizes the difference in volume between the true UD and the estimates UD.\n-   A subjective visual choice for the smoothing parameter, based on successive trials (Silverman, 1986; Wand & Jones 1995).\n\nOther parameters include:\n\n-   Kernel Type: The type of kernel is limited to Gaussian (bivariate normal), quadratic or normal. We used the bivariate normal model as default.\n\n-   Grid/extent: These determines the area or extent over which the home range will be estimated. This is a mix of fine scale and time consuming processing and faster blocky resolution over a continuous surface. As a rule of thumb you GME suggests: take the square root of the x or y variance value (whichever is smaller) and divide by 5 or 10 (I usually round to the nearest big number - so 36.7 becomes 40). Before using this rule of thumb value calculate how many cells this will result in for the output (take the width and height of you input points, divide by the cell size, and multiply the resulting numbers together). If you get a value somewhere between 1-20 million, then you have a reasonable value.\n\nTo create home ranges for each unique id we used a bivariate normal kernel with a variety of h (smoothing parameters). We then interpreted visually to determine size to use based on successive trials. This is supported by the literature (Hemson et al. 2005; Calenge et al. 2011).\n\nIt is also possible to run KDE with set barriers and boundaries.\n\n#### 3.1 kde: h reference parameter\n\n\n::: {.cell}\n\n```{.r .cell-code}\n  tdfu <- tdf  %>% dplyr::select(location.long, location.lat, season)\n    \n  # Create a SpatialPointsDataFrame by defining the coordinates\n  coordinates(tdfu) <- c(\"location.long\", \"location.lat\")\n  proj4string(tdfu) <- CRS( \"+proj=longlat +datum=WGS84 +units=m +no_defs\" )\n  tdfgeo <- spTransform(tdfu, CRS(\"+init=epsg:3005\")) # Transform to UTM \n\n  # define the parameters (h, kern, grid, extent) \n  kde_href  <- kernelUD(tdfgeo, h = \"href\", kern = c(\"bivnorm\"), grid = 500, extent = 2)\n  \n  kde_href\n```\n:::\n\n\nFrom this object (**Utilization distribution of several Animals**) we can extract the vertices or polygons which define the percentage we wish to include.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n  ver95 <- getverticeshr(kde_href,95) # get vertices for home range\n  ver95_sf <- st_as_sf(ver95)         # convert to sf object \n  \n  ver75 <- getverticeshr(kde_href,75)\n  ver75_sf <- st_as_sf(ver75 )\n  \n  ver50 <- getverticeshr(kde_href,50)\n  ver50_sf<- st_as_sf(ver50)\n \n  # plot the outputs \n  mapview(ver50_sf, zcol = \"id\") \n  mapview (ver75_sf, zcol = \"id\")\n  mapview (ver95_sf, zcol = \"id\")\n  \n  plot(st_geometry(ver95.2.sf),col = \"yellow\") \n  plot(st_geometry(ver75.2.sf),col = \"blue\", add = TRUE)\n  plot(st_geometry(ver50.2.sf),col = \"purple\", add = TRUE)\n  plot(tdfgeo, pch = 1, size = 0.5, add = TRUE)     # Add points \n```\n:::\n\n\n#### 3.2 kde: Least Squares Cross Validation (lscv) method.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n  kde_lscv  <- kernelUD(tdfgeo, h = \"LSCV\", kern = c(\"bivnorm\"), grid = 500, extent = 2)\n```\n:::\n\n\n#### 3.3 kde: variable smoothing parameters (h)\n\nTo test the sensitivity of the h value we can test a bivariate normal kernel with a variety of smoothing parameters (h = 1000, 2000, 4000).\n\nWe can then interpreted visually to determine size to use based on successive trials. This approach is supported by literature (Hemson et al. 2005; Calenge et al. 2011).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkde_h1000  <- kernelUD(tdfgeo, h = 1000, kern = c(\"bivnorm\"), grid = 500,extent = 2)\nkde_h500  <- kernelUD(tdfgeo, h = 500, kern = c(\"bivnorm\"), grid = 500,extent = 2)\nkde_h3000  <- kernelUD(tdfgeo, h = 3000, kern = c(\"bivnorm\"), grid = 500,extent = 2)\n```\n:::\n\n\nLets extract the verticies and compare the outputs by building a plot.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# kde - href = 1000\n  ver95_1000 <- getverticeshr(kde_h1000, 95) # get vertices for home range\n  ver95_1000_sf <- st_as_sf(ver95_1000) %>%\n    mutate(h = 1000) # convert to sf object \n\n# kde - href = 500\n  ver95_500 <- getverticeshr(kde_h500, 95) # get vertices for home range\n  ver95_500_sf <- st_as_sf(ver95_500)  %>%\n    mutate(h = 500) # convert to sf object \n  \n  \n# kde - href = 3000\n  ver95_3000 <- getverticeshr(kde_h3000, 95) # get vertices for home range\n  ver95_3000_sf <- st_as_sf(ver95_3000)  %>%\n    mutate(h = 3000) # convert to sf object \n  \n# bind all data together \n  all_verts <- bind_rows(ver95_1000_sf,  ver95_500_sf,  ver95_3000_sf)\n  \n# lets plot the output \n  ggplot(data = all_verts) +\n  geom_sf(\n    aes(colour = id), \n    alpha = 0.1\n  ) + \n  scale_colour_viridis_d() + \n  facet_wrap(vars(h)) +\n  theme_bw()\n```\n:::\n\n\n### References\n\n-   Packages: estimate Kernel home range Utiliation Distribution Using adehabitatHR (Calenge et al. 2011) (https://cran.r-project.org/web/packages/adehabitatHR/vignettes/adehabitatHR.pdf)\n-   KDE : \"http://www.spatialecology.com/gme/kde.htm\"\n-   https://www.ckwri.tamuk.edu/sites/default/files/publication/pdfs/2017/leonard_analyzing_wildlife_telemetry_data_in_r.pdf\n-   Seaman, D. E., Millspaugh, J. J., Kernohan, B. J., Brundige, G. C., Raedeke, K. J., & Gitzen, R. A. (1999). Effects of sample #size on kernel home range estimates. The journal of wildlife management, 739-747.\n-   Kernohan, B. J., R. A. Gitzen, and J. J. Millspaugh. 2001. Analysis of animal space use and movements. Pages 125--166 in J. J. #Millspaugh and J. M. Marzluff, editors. Radio tracking and animal populations. Academic Press, San Diego, CA, USA\n-   Hemson, G., Johnson, P., South, A., Kenward, R., Ripley, R., & MACDONALD, D. (2005). Are kernels the mustard? Data from global positioning system (GPS) collars suggests problems for kernel home‐range analyses with least‐squares cross‐validation. Journal of Animal Ecology, 74(3), 455-463\n",
    "supporting": [
      "bonus-kde_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}